version: '3.8'

services:
  # Redis for alert publishing
  redis:
    image: redis:7-alpine
    container_name: test-redis
    ports:
      - "6379:6379"
    networks:
      - test-network

  # Test service 1 - Always healthy
  healthy-service:
    image: nginx:alpine
    container_name: test-healthy-service
    labels:
      - "spreadpilot"
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 5s
      timeout: 3s
      retries: 3

  # Test service 2 - Becomes unhealthy
  unhealthy-service:
    image: python:3.11-slim
    container_name: test-unhealthy-service
    labels:
      - "spreadpilot"
    networks:
      - test-network
    volumes:
      - ./mock_service.py:/app/mock_service.py
    command: python /app/mock_service.py
    ports:
      - "8081:8080"

  # Test service 3 - No health endpoint
  no-health-service:
    image: busybox
    container_name: test-no-health-service
    labels:
      - "spreadpilot"
    networks:
      - test-network
    command: sleep 3600

  # Watchdog service under test
  watchdog:
    build:
      context: ../..
      dockerfile: watchdog/Dockerfile
    container_name: test-watchdog
    environment:
      - CHECK_INTERVAL_SECONDS=5
      - MAX_CONSECUTIVE_FAILURES=3
      - REDIS_URL=redis://redis:6379
      - LOG_LEVEL=DEBUG
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - test-network
    depends_on:
      - redis
      - healthy-service
      - unhealthy-service
      - no-health-service

networks:
  test-network:
    driver: bridge