+++
id = "TASK-TEST-20250429-083200"
title = "Fix Failing Integration Tests for Admin API (Post-MongoDB Refactor)"
status = "üü° To Do"
type = "üêû Bug" # Fixing failing tests is considered a bug fix
priority = "‚ñ∂Ô∏è High" # Blocking further validation/deployment
created_date = "2025-04-29"
updated_date = "2025-04-29"
# due_date = ""
# estimated_effort = ""
assigned_to = "test-integration"
# reporter = "roo-commander"
parent_task = "TASK-CMD-20250429-003830" # Commander's coordinating task
depends_on = ["TASK-LEADBE-20250429-004130"] # Depends on the backend refactor being 'done'
related_docs = [".ruru/decisions/20250429-adopt-mongodb-primary-database.md"]
tags = ["testing", "integration-test", "bugfix", "mongodb", "admin-api", "pytest"]
template_schema_doc = ".ruru/templates/toml-md/02_mdtm_bug.md" # Using bug template
# ai_prompt_log = """"""
# review_checklist = []
# reviewed_by = ""
# key_learnings = ""
+++

# Fix Failing Integration Tests for Admin API (Post-MongoDB Refactor)

## Description ‚úçÔ∏è

*   **What is the bug?** Several integration tests in `tests/integration/test_admin_api.py` are failing after the `admin-api` service was refactored to use MongoDB.
*   **Why is it happening?** Likely due to changes in data types (UUID vs ObjectId), import paths, or mocking/logging configurations introduced during the refactoring.
*   **Impact:** Prevents verification of the `admin-api` functionality with the new database.
*   **Links:**
    *   ADR: `.ruru/decisions/20250429-adopt-mongodb-primary-database.md`
    *   Refactor Task: `TASK-LEADBE-20250429-004130`

## Steps to Reproduce üîÅ

1.  Run the integration tests (e.g., via `pytest tests/integration/test_admin_api.py` or the relevant `make` target).
2.  Observe the failures reported in the test summary.

## Expected Behavior ‚úÖ

*   All tests in `tests/integration/test_admin_api.py` should pass.

## Actual Behavior ‚ùå

*   **FAILED:** `test_follower_service_integration` - `bson.errors.InvalidId: '...' is not a valid ObjectId...`
*   **FAILED:** `test_trigger_close_positions_service` - `ModuleNotFoundError: No module named 'admin_api'`
*   **ERROR:** `test_list_followers` - `ValueError: invalid format: 'admin-api.app.api.v1.endpoints.dashboard'`
*   **ERROR:** `test_create_follower` - `ValueError: invalid format: 'admin-api.app.api.v1.endpoints.dashboard'`
*   **ERROR:** `test_toggle_follower` - `ValueError: invalid format: 'admin-api.app.api.v1.endpoints.dashboard'`
*   **ERROR:** `test_toggle_nonexistent_follower` - `ValueError: invalid format: 'admin-api.app.api.v1.endpoints.dashboard'`
*   **ERROR:** `test_trigger_close_positions` - `ValueError: invalid format: 'admin-api.app.api.v1.endpoints.dashboard'`
*   **ERROR:** `test_trigger_close_positions_nonexistent_follower` - `ValueError: invalid format: 'admin-api.app.api.v1.endpoints.dashboard'`

## Implementation Notes / Debugging Steps üìù

*   **InvalidId:** Examine `test_follower_service_integration`. Check how follower IDs are generated or used in test data/fixtures. Ensure they conform to MongoDB ObjectId format or adjust the test logic/assertions.
*   **ModuleNotFoundError:** Investigate `test_trigger_close_positions_service`. Check imports within the test file and `conftest.py`. Verify `PYTHONPATH` or test runner configuration. Ensure the `admin_api` module is correctly importable in the test context.
*   **ValueError (invalid format):** This affects multiple tests. Investigate the common setup in `conftest.py` and the specific test functions. Focus on how logging is configured or mocked, especially concerning the `admin-api.app.api.v1.endpoints.dashboard` path. Compare with `admin-api/app/main.py` and `admin-api/app/core/config.py`. Adjust mocks or test setup as needed.
*   Relevant files: `tests/integration/test_admin_api.py`, `tests/integration/conftest.py`.

## Acceptance Criteria ‚úÖ

*   - [ ] All tests listed in "Actual Behavior" now pass when run.
*   - [ ] No new tests are failing.
*   - [ ] Test fixes address the root cause of each error type.