+++
id = "TASK-REFACTOR-20250430-174200"
title = "Refactor: Migrate Data Access from Firestore to MongoDB"
status = "üü£ Review"
type = "‚ôªÔ∏è Refactoring"
assigned_to = "util-refactor"
coordinator = "TASK-CMD-20250430-155610"
created_date = "2025-04-30T17:42:00Z"
updated_date = "2025-04-30T18:02:00Z" # Approximate current time
tags = ["refactoring", "database", "firestore", "mongodb", "google-cloud", "dependencies", "data-migration"]
related_tasks = ["TASK-REFACTOR-20250430-155700"] # Related to secret manager refactor
related_docs = [".context/stack_profile.json", "spreadpilot-core/spreadpilot_core/models/"]
complexity = "Very High"
estimated_effort = "Very Large"
+++

# Refactor: Migrate Data Access from Firestore to MongoDB

**Objective:** Remove the dependency on `google-cloud-firestore` by migrating all data persistence and retrieval logic to use MongoDB.

**Background:** The project currently uses Google Cloud Firestore for data storage, primarily accessed via `spreadpilot-core`. As part of removing Google Cloud dependencies, this needs to be replaced with MongoDB, which is already used for other purposes (like the secret store implemented in `TASK-REFACTOR-20250430-155700`).

**Acceptance Criteria:**

1.  All code interacting with Firestore (client initialization, reads, writes, queries) is identified and refactored to use the MongoDB Python driver (`pymongo`).
2.  Existing MongoDB connection logic (e.g., in `admin_api/app/db/mongodb.py`) should be leveraged or centralized within `spreadpilot-core` if appropriate.
3.  Data models defined in `spreadpilot-core/spreadpilot_core/models/` might need adjustments for MongoDB's document structure (consider Pydantic models if not already used consistently).
4.  The `google-cloud-firestore` dependency is completely removed from `spreadpilot-core/setup.py` and any other relevant dependency files.
5.  All relevant tests (unit, integration) are updated to mock/use MongoDB instead of Firestore and pass successfully.
6.  Dependency files (`requirements*.txt`) are updated (e.g., via `make compile-deps` or equivalent) to reflect the removal.
7.  The application remains functionally equivalent regarding data persistence and retrieval.

**Checklist:**

*   [ ] **Identify Firestore Usage:** Search the codebase (especially `spreadpilot-core` and service layers like `admin_api/app/services/`) for imports and usage of `google.cloud.firestore`.
*   [ ] **Analyze Data Models:** Review models in `spreadpilot-core/spreadpilot_core/models/` (e.g., `follower.py`, `alert.py`, `position.py`, `trade.py`). Determine necessary adjustments for MongoDB document storage (e.g., handling of IDs `_id`, relationships).
*   [ ] **Centralize/Implement MongoDB Client:** Ensure a consistent way to access the `pymongo` client/database/collections, potentially centralizing connection logic in `spreadpilot-core`.
*   [ ] **Refactor Data Access Logic:** Replace all Firestore `get()`, `set()`, `update()`, `where()`, etc., calls with equivalent `pymongo` operations (`find_one()`, `insert_one()`, `update_one()`, `find()`, etc.).
*   [ ] **Remove Firestore Dependency:** Remove `google-cloud-firestore` from `spreadpilot-core/setup.py`.
*   [ ] **Update Tests:** Refactor existing tests that interact with the data layer to use mocked or test-containerized MongoDB instead of Firestore. Ensure comprehensive coverage of the new data access logic.
*   [ ] **Update Dependency Files:** Run `make compile-deps` (or equivalent `pip-compile` commands) to regenerate `requirements*.txt` files.
*   [ ] **Verify Functionality:** (Manual or Automated) Ensure applications can still perform all CRUD operations correctly using MongoDB.
*   [ ] **Documentation:** (Action Required post-completion) Note the database change in relevant documentation.

**Notes:**

*   This task focuses on refactoring the *code*. Data migration from an existing Firestore instance to MongoDB is **out of scope** for this task but will be required separately.
*   Pay close attention to how relationships and queries are handled differently between Firestore and MongoDB.
*   Ensure appropriate indexing strategies are considered for MongoDB collections based on query patterns (though implementation might be a separate task).