+++
id = "TASK-TEST-20250430-162300"
title = "Implement Tests for MongoDB Secret Retrieval"
status = "ðŸŸ¡ To Do"
type = "ðŸ§ª Testing"
assigned_to = "test-developer"
coordinator = "TASK-CMD-20250430-155610"
created_date = "2025-04-30T16:23:00Z"
updated_date = "2025-04-30T16:23:00Z"
tags = ["testing", "unit-test", "integration-test", "secrets", "mongodb", "refactoring"]
related_tasks = ["TASK-REFACTOR-20250430-155700"]
related_docs = ["spreadpilot-core/spreadpilot_core/utils/secrets.py"]
complexity = "Medium"
estimated_effort = "Medium"
+++

# Implement Tests for MongoDB Secret Retrieval

**Objective:** Create unit and integration tests for the recently implemented MongoDB secret retrieval mechanism introduced in task `TASK-REFACTOR-20250430-155700`.

**Background:** The codebase was refactored to remove `google-cloud-secret-manager` and use MongoDB for secrets. The core retrieval logic is in `spreadpilot-core/spreadpilot_core/utils/secrets.py` (`get_secret_from_mongo` function), and service startup logic in `main.py` files was updated to pre-load secrets. Tests for this new functionality are required.

**Acceptance Criteria:**

1.  Unit tests are created for the `get_secret_from_mongo` function in `spreadpilot-core/spreadpilot_core/utils/secrets.py`, covering success cases, secret-not-found cases, and potential error conditions (e.g., MongoDB connection issues, if mockable).
2.  Integration tests are created (or existing ones updated) to verify that services (`admin_api`, `alert_router`, `report_worker`, `trading-bot`) correctly load secrets from MongoDB into environment variables during startup as expected by the configuration classes (e.g., `pydantic-settings`). This likely involves mocking the MongoDB connection/data during testing.
3.  All new tests pass successfully.
4.  Test coverage for the new secret retrieval logic is adequate.

**Checklist:**

*   [ ] **Implement Unit Tests:** Write unit tests for `spreadpilot-core/spreadpilot_core/utils/secrets.py` using an appropriate testing framework (e.g., `pytest`) and mocking library (e.g., `unittest.mock`).
*   [ ] **Implement Integration Tests:** Write integration tests (or modify existing ones in `tests/integration/`) to verify the secret pre-loading mechanism during service startup. Mock MongoDB interactions.
*   [ ] **Run Tests:** Execute all tests (`pytest` or equivalent) and ensure they pass.
*   [ ] **Review Coverage:** (Optional but recommended) Check test coverage for the new code paths.

**Notes:**

*   Refer to `tests/integration/conftest.py` for existing testing fixtures and patterns, especially regarding MongoDB mocking if available.
*   Ensure tests clean up any mocked resources properly.