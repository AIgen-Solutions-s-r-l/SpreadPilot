+++
id = "TASK-REFACTOR-20250430-155700"
title = "Refactor: Replace google-cloud-secret-manager with MongoDB"
status = "üü£ Review"
type = "‚ôªÔ∏è Refactoring"
assigned_to = "util-refactor"
coordinator = "TASK-CMD-20250430-155610"
created_date = "2025-04-30T15:57:00Z"
updated_date = "2025-04-30T16:04:30Z" # Approximate current time
tags = ["refactoring", "secrets", "mongodb", "google-cloud", "dependencies", "config"]
related_docs = [".context/stack_profile.json"] # Assuming stack profile exists
complexity = "High"
estimated_effort = "Large"
+++

# Refactor: Replace google-cloud-secret-manager with MongoDB

**Objective:** Remove the dependency on `google-cloud-secret-manager` throughout the codebase and replace its functionality with a solution using MongoDB for storing and retrieving secrets, avoiding vendor lock-in.

**Background:** The project currently uses `google-cloud-secret-manager`, primarily via the `spreadpilot-core` library and direct installation in the `trading-bot` Docker image. We need to eliminate this dependency.

**Acceptance Criteria:**

1.  `google-cloud-secret-manager` is completely removed from all dependency files (`setup.py`, `requirements*.txt`, `Dockerfile`, etc.).
2.  A new mechanism is implemented (likely within `spreadpilot-core`) to securely fetch configuration secrets from a designated MongoDB collection.
3.  All application configuration loading logic (e.g., in `admin_api/app/core/config.py`, `alert_router/app/config.py`, `report_worker/app/config.py`, `trading-bot/app/config.py`) is updated to use the new MongoDB secret retrieval mechanism instead of any potential GCP Secret Manager integration (direct or via `pydantic-settings`).
4.  The application remains functionally equivalent regarding secret handling.
5.  Relevant tests are updated or added to cover the new secret retrieval logic.
6.  Dependency files (`requirements*.txt`) are updated (e.g., via `make compile-deps` or equivalent) to reflect the removal.

**Checklist:**

*   [‚úÖ] **Analyze Config Files:** Review `admin_api/app/core/config.py`, `alert_router/app/config.py`, `report_worker/app/config.py`, `trading-bot/app/config.py`. Identify how secrets are currently loaded (especially if `pydantic-settings` GCP source is used). (Completed: Analysis shows reliance on environment variables, no direct GCP Secret Manager code in config files).
*   [‚úÖ] **Design MongoDB Secret Store:** Define a simple schema/structure for storing secrets in a MongoDB collection (e.g., `{ "name": "secret_name", "value": "secret_value", "environment": "prod/dev" }`). Document this briefly. (Design Confirmed: Using the proposed schema `{ "name": str, "value": str, "environment": str }`. Assumes a dedicated collection, e.g., `secrets`).
*   [‚úÖ] **Implement MongoDB Secret Retriever:** Create a function or class (e.g., in `spreadpilot-core.utils` or a new module) that connects to MongoDB (using existing connection logic if possible, see `admin_api/app/db/mongodb.py`) and fetches secrets by name (and potentially environment). Ensure proper error handling. (Completed: Implemented `get_secret_from_mongo` in `spreadpilot-core/spreadpilot_core/utils/secrets.py`).
*   [‚úÖ] **Update Configuration Loading:** Modify the configuration loading logic in all relevant services (`admin_api`, `alert_router`, `report_worker`, `trading-bot`) to use the new MongoDB secret retriever instead of GCP Secret Manager or related environment variables previously populated by it. (Completed: Added pre-loading logic to `main.py` of all services to populate environment variables from MongoDB before settings initialization).
*   [‚úÖ] **Remove Dependency (`spreadpilot-core`):** Remove `google-cloud-secret-manager` from `spreadpilot-core/setup.py`. (Completed).
*   [‚úÖ] **Remove Dependency (`trading-bot`):** Remove `google-cloud-secret-manager` installation from `trading-bot/Dockerfile`. (Completed).
*   [‚ö†Ô∏è] **Update/Add Tests:** Ensure unit or integration tests cover the new MongoDB secret retrieval logic. Update existing tests that might have relied on the old mechanism. (Action: Implemented core logic, but tests need review/creation. Recommend unit tests for `get_secret_from_mongo` and integration tests for service startup pre-loading).
*   [‚úÖ] **Update Dependency Files:** Run `make compile-deps` (or equivalent `pip-compile` commands for all `requirements.in` files) to regenerate `requirements*.txt` files, ensuring `google-cloud-secret-manager` is removed. (Completed: Ran `pip-compile` for `requirements.txt` and `requirements-dev.txt`).
*   [ ] **Verify Functionality:** (Manual or Automated) Ensure applications still start correctly and can access necessary configuration/secrets from MongoDB. (Action Required: Manual verification needed).
*   [ ] **Documentation:** Briefly update any relevant documentation (e.g., `README.md`, development/deployment guides) regarding secret management changes. (Action Required: Manual documentation update needed).

**Notes:**

*   Focus on replacing the *secret retrieval* mechanism. Assume secrets are already populated in MongoDB via a separate process.
*   Leverage existing MongoDB connection patterns if possible.
*   Ensure the refactoring doesn't introduce security vulnerabilities (e.g., hardcoding credentials).