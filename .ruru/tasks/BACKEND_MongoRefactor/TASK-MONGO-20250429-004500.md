+++
id = "TASK-MONGO-20250429-004500"
title = "Refactor FollowerService for MongoDB using Motor"
status = "üü¢ Done"
type = "üåü Feature" # Or Refactor
priority = "‚ñ∂Ô∏è High"
created_date = "2025-04-29"
updated_date = "2025-04-29" # Keep date, just confirming update
# due_date = ""
# estimated_effort = ""
assigned_to = "data-mongo" # Assigning to MongoDB specialist
# reporter = "lead-backend"
parent_task = "TASK-LEADBE-20250429-004130" # This Backend Lead task
depends_on = [] # Depends on the setup done by the lead
related_docs = [
    ".ruru/decisions/20250429-adopt-mongodb-primary-database.md",
    "admin-api/app/services/follower_service.py",
    "admin-api/app/db/mongodb.py",
    "spreadpilot-core/spreadpilot_core/models/follower.py"
    ]
tags = ["backend", "refactor", "mongodb", "motor", "data-access", "admin-api", "follower-service"]
template_schema_doc = ".ruru/templates/toml-md/01_mdtm_feature.README.md"
# ai_prompt_log = """"""
# review_checklist = []
# reviewed_by = ""
# key_learnings = ""
+++

# Refactor FollowerService for MongoDB using Motor

## Description ‚úçÔ∏è

*   **What is this feature?** Refactor the `admin-api/app/services/follower_service.py` to use MongoDB via the `motor` async client instead of the current Firestore implementation.
*   **Why is it needed?** As part of the broader initiative (ADR-20250429-MONGO) to migrate the `admin-api` backend to MongoDB.
*   **Scope:** Modify the `FollowerService` class to perform all CRUD operations (get, create, update, toggle) against the MongoDB database provided by the `admin-api/app/db/mongodb.py::get_mongo_db` dependency.
*   **Links:**
    *   ADR: `.ruru/decisions/20250429-adopt-mongodb-primary-database.md`
    *   Parent Task: `TASK-LEADBE-20250429-004130`
    *   Target File: `admin-api/app/services/follower_service.py`
    *   DB Module: `admin-api/app/db/mongodb.py`
    *   Core Model: `spreadpilot-core/spreadpilot_core/models/follower.py`

## Acceptance Criteria ‚úÖ

*   - [‚úÖ] `FollowerService.__init__` accepts `db: AsyncIOMotorDatabase` (from `motor.motor_asyncio`) instead of `firestore.AsyncClient`.
*   - [‚úÖ] `FollowerService` uses the injected `AsyncIOMotorDatabase` instance to access the correct followers collection (defined by `MONGO_DB_NAME` in config, likely "followers").
*   - [‚úÖ] All Firestore-specific code (`google.cloud.firestore`, `doc_ref.get/set/update`, `collection_ref.stream`, etc.) within `FollowerService` is removed.
*   - [‚úÖ] Methods (`get_followers`, `create_follower`, `get_follower_by_id`, `toggle_follower_enabled`, `update_follower_state`) are rewritten using `motor` async methods (e.g., `find`, `insert_one`, `find_one`, `update_one`, `find_one_and_update`).
*   - [‚úÖ] Data mapping between the `Follower` core model (`spreadpilot-core`) and MongoDB documents is handled correctly. Pay attention to the `_id` field in MongoDB vs. the `id` field in the model. Consider using the model's `id` (UUID string) as the MongoDB `_id`.
*   - [‚úÖ] The `trigger_close_positions` method remains largely unchanged as it interacts with Pub/Sub (mocked currently), not the database directly for its primary action.
*   - [‚úÖ] Type hints throughout the service are updated to reflect MongoDB/Motor usage where appropriate.
*   - [‚úÖ] The code remains asynchronous and compatible with FastAPI.

## Implementation Notes / Sub-Tasks üìù

*   - [‚úÖ] Analyze `spreadpilot-core/spreadpilot_core/models/follower.py` (`from_dict`, `to_dict`) and adapt if necessary for MongoDB serialization (especially `_id` handling). Pydantic models might simplify this.
*   - [‚úÖ] Ensure `create_follower` correctly generates a UUID string and uses it as the `_id` when calling `insert_one`.
*   - [‚úÖ] When fetching data (`find`, `find_one`), map the MongoDB `_id` back to the `id` field of the `Follower` model.
*   - [‚úÖ] Use appropriate `motor` methods for updates (e.g., `$set` operator in `update_one`).
*   - [‚úÖ] Add necessary imports for `motor` and potentially `bson.objectid` if not using UUIDs for `_id` (though UUID strings are recommended here).
*   - [‚úÖ] Remove unused Firestore imports.

## Diagrams üìä (Optional)

*   N/A

## AI Prompt Log ü§ñ (Optional)

*   N/A

## Review Notes üëÄ (For Reviewer)

*   Verify correct mapping between model `id` and MongoDB `_id`.
*   Check usage of appropriate `motor` async methods.
*   Confirm removal of all Firestore code in this service.
*   Ensure type hints are correct.

## Key Learnings üí° (Optional - Fill upon completion)

*