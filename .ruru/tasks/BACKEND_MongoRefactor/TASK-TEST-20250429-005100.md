+++
id = "TASK-TEST-20250429-005100"
title = "Update Integration Tests for Admin API MongoDB Refactor"
status = "‚ö™ Blocked" # Changed status as test run verification failed
type = "üß™ Test"
priority = "‚ñ∂Ô∏è High" # Important to ensure refactor didn't break things
created_date = "2025-04-29"
updated_date = "2025-04-29" # Update date
# due_date = ""
# estimated_effort = ""
assigned_to = "test-integration" # Or dev-python if no dedicated tester
# reporter = "lead-backend"
parent_task = "TASK-LEADBE-20250429-004130" # This Backend Lead task
depends_on = ["TASK-MONGO-20250429-004500"] # Depends on FollowerService refactor
related_docs = [
    "tests/integration/test_admin_api.py",
    "tests/integration/conftest.py",
    "admin-api/app/services/follower_service.py",
    ".ruru/tasks/BACKEND_MongoRefactor/TASK-MONGO-20250429-004500.md"
    ]
tags = ["backend", "testing", "integration-test", "mongodb", "admin-api", "pytest"]
template_schema_doc = ".ruru/templates/toml-md/04_mdtm_test.README.md" # Assuming this template exists
# ai_prompt_log = """"""
# review_checklist = []
# reviewed_by = ""
# key_learnings = ""
+++

# Update Integration Tests for Admin API MongoDB Refactor

## Description ‚úçÔ∏è

*   **Goal:** Update the integration tests for the `admin-api` service (primarily focusing on follower endpoints) to correctly function after the refactoring of `FollowerService` to use MongoDB instead of Firestore.
*   **Context:** The `FollowerService` (`admin-api/app/services/follower_service.py`) has been updated to interact with a MongoDB database (Task `TASK-MONGO-20250429-004500`). Existing integration tests in `tests/integration/` likely rely on Firestore fixtures or mocks and need adaptation.
*   **Scope:** Modify test fixtures (`tests/integration/conftest.py`) and test cases (`tests/integration/test_admin_api.py` or similar) to work with MongoDB. This might involve setting up a test MongoDB instance (e.g., using `docker-compose` overrides or a library like `mongomock` or `testcontainers`) or effectively mocking the MongoDB client/database dependency (`get_mongo_db`).
*   **Links:**
    *   Parent Task: `TASK-LEADBE-20250429-004130`
    *   Refactored Service Task: `TASK-MONGO-20250429-004500`
    *   Test Files: `tests/integration/test_admin_api.py`, `tests/integration/conftest.py`

## Acceptance Criteria ‚úÖ

*   - [‚úÖ] Test fixtures in `conftest.py` are updated to provide a suitable MongoDB testing environment (e.g., connection to a test DB, cleanup logic, potentially mocking). (Implemented using Testcontainers)
*   - [‚ùì] Existing integration tests related to follower CRUD operations in `test_admin_api.py` (or equivalent) pass successfully against the MongoDB-backed service. (Code updated, needs verification - pytest run output incomplete)
*   - [‚úÖ] Tests correctly handle the interaction with the MongoDB database, verifying data creation, retrieval, updates, and deletions as performed by the API endpoints. (Test code updated to use MongoDB operations)
*   - [‚úÖ] Any Firestore-specific fixtures or mocks related to the admin API tests are removed or replaced. (Removed from conftest.py and test_admin_api.py)
*   - [‚ùì] The test suite runs without errors related to the database interaction changes. (Needs verification - pytest run output incomplete)

## Implementation Notes / Sub-Tasks üìù

*   - [‚úÖ] Analyze `tests/integration/conftest.py` to understand the current fixture setup (e.g., how the FastAPI `client` and database dependencies are handled).
*   - [‚úÖ] Decide on a MongoDB testing strategy: (Chose Real Test DB via Testcontainers)
    *   **Real Test DB:** Use `testcontainers` or a dedicated Docker Compose override file (`docker-compose.test.yml`?) to spin up a temporary MongoDB container for tests. Fixtures would need to manage connection and cleanup.
    *   **Mocking:** Use `pytest-mock` to mock the `get_mongo_db` dependency or the `motor` client/database/collection objects directly. This avoids needing a real DB but tests less of the actual interaction.
    *   **In-Memory DB:** Use `mongomock` if full MongoDB feature compatibility isn't strictly required for these tests.
*   - [‚úÖ] Implement the chosen strategy in `conftest.py`. (Added Testcontainers fixtures and dependency override)
*   - [‚úÖ] Modify test functions in `test_admin_api.py` to assert against expected MongoDB interactions or resulting data states. Pay attention to how follower IDs (`_id`) are handled. (Refactored tests for MongoDB)
*   - [‚úÖ] Ensure tests clean up any data created in the test database after each test run or session. (Handled by `test_mongo_db` fixture and within tests)

## Diagrams üìä (Optional)

*   N/A

## AI Prompt Log ü§ñ (Optional)

*   N/A

## Review Notes üëÄ (For Reviewer)

*   Verify the chosen testing strategy (real DB vs. mock) is appropriate.
*   Check that tests cover essential CRUD operations for followers via the API.
*   Ensure proper test isolation and data cleanup.
*   Confirm removal of Firestore-related test code.
*   **NOTE:** Test execution via `pytest` did not return a clear success/fail status due to terminal output issues. Manual verification of the test run is required. Command used: `PYTHONPATH=. .venv/bin/pytest tests/integration/test_admin_api.py -v`

## Key Learnings üí° (Optional - Fill upon completion)

*