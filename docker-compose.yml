version: '3.8'

services:
  # Core services
  trading-bot:
    build:
      context: .
      dockerfile: trading-bot/Dockerfile
    container_name: spreadpilot-trading-bot
    labels:
      - "spreadpilot"
    environment:
      - GOOGLE_CLOUD_PROJECT=spreadpilot-dev
      - MONGO_URI=mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongodb:27017
      - MONGO_DB_NAME=spreadpilot_admin
      - IB_GATEWAY_HOST=ib-gateway
      - IB_GATEWAY_PORT=4002
      - REDIS_URL=redis://redis:6379
      - VAULT_ENABLED=${VAULT_ENABLED:-true}
      - VAULT_ADDR=${VAULT_ADDR:-http://vault:8200}
      - VAULT_TOKEN=${VAULT_TOKEN}
      - VAULT_MOUNT_POINT=${VAULT_MOUNT_POINT:-secret}
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - GOOGLE_SHEET_URL=${GOOGLE_SHEET_URL}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials/service-account.json
    volumes:
      - ./credentials:/app/credentials
      - /var/run/docker.sock:/var/run/docker.sock  # For gateway manager
    depends_on:
      - mongodb
      - redis
      - vault
    ports:
      - "8001:8001"
    networks:
      - spreadpilot-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; r = httpx.get('http://localhost:8001/health'); r.raise_for_status()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  watchdog:
    build:
      context: .
      dockerfile: watchdog/Dockerfile
    container_name: spreadpilot-watchdog
    environment:
      - CHECK_INTERVAL_SECONDS=15
      - HEALTH_CHECK_TIMEOUT=5
      - MAX_CONSECUTIVE_FAILURES=3
      - REDIS_URL=redis://redis:6379
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock  # Docker socket for container management
    depends_on:
      - redis
      - trading-bot
      - admin-api
      - report-worker
      - alert-router
      - frontend
    networks:
      - spreadpilot-network
    restart: unless-stopped

  admin-api:
    build:
      context: .
      dockerfile: admin-api/Dockerfile
    container_name: spreadpilot-admin-api
    labels:
      - "spreadpilot"
    environment:
      - GOOGLE_CLOUD_PROJECT=spreadpilot-dev
      - MONGO_URI=mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongodb:27017
      - MONGO_DB_NAME=spreadpilot_admin
      - REDIS_URL=redis://redis:6379
      - TRADING_BOT_HOST=trading-bot
      - TRADING_BOT_PORT=8001
      - VAULT_ENABLED=${VAULT_ENABLED:-true}
      - VAULT_ADDR=${VAULT_ADDR:-http://vault:8200}
      - VAULT_TOKEN=${VAULT_TOKEN}
      - VAULT_MOUNT_POINT=${VAULT_MOUNT_POINT:-secret}
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD_HASH=${ADMIN_PASSWORD_HASH}
      - JWT_SECRET=${JWT_SECRET:-testsecret}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials/service-account.json
    volumes:
      - ./credentials:/app/credentials
    depends_on:
      - mongodb
      - redis
      - trading-bot
      - vault
    ports:
      - "8083:8080"
    networks:
      - spreadpilot-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; r = httpx.get('http://localhost:8080/health'); r.raise_for_status()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  report-worker:
    build:
      context: .
      dockerfile: report-worker/Dockerfile
    container_name: spreadpilot-report-worker
    labels:
      - "spreadpilot"
    environment:
      - GOOGLE_CLOUD_PROJECT=spreadpilot-dev
      - MONGO_URI=mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongodb:27017
      - MONGO_DB_NAME=spreadpilot_admin
      - VAULT_ENABLED=${VAULT_ENABLED:-true}
      - VAULT_ADDR=${VAULT_ADDR:-http://vault:8200}
      - VAULT_TOKEN=${VAULT_TOKEN}
      - VAULT_MOUNT_POINT=${VAULT_MOUNT_POINT:-secret}
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials/service-account.json
    volumes:
      - ./credentials:/app/credentials
      - ./reports:/app/reports
    networks:
      - spreadpilot-network
    depends_on:
      - mongodb
      - vault
    restart: unless-stopped

  alert-router:
    build:
      context: .
      dockerfile: alert-router/Dockerfile
    container_name: spreadpilot-alert-router
    labels:
      - "spreadpilot"
    environment:
      - REDIS_URL=redis://redis:6379
      - MONGO_URI=mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongodb:27017
      - MONGO_DB_NAME=spreadpilot_admin
      - VAULT_ENABLED=${VAULT_ENABLED:-true}
      - VAULT_ADDR=${VAULT_ADDR:-http://vault:8200}
      - VAULT_TOKEN=${VAULT_TOKEN}
      - VAULT_MOUNT_POINT=${VAULT_MOUNT_POINT:-secret}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - SMTP_URI=${SMTP_URI}
      - EMAIL_FROM=${EMAIL_FROM:-alerts@spreadpilot.com}
      - EMAIL_TO=${EMAIL_TO:-admin@spreadpilot.com}
    ports:
      - "8006:8006"
    networks:
      - spreadpilot-network
    depends_on:
      - redis
      - mongodb
      - vault
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; r = httpx.get('http://localhost:8006/health'); r.raise_for_status()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: spreadpilot-frontend
    labels:
      - "spreadpilot"
    ports:
      - "8080:80"
    depends_on:
      - admin-api
    restart: unless-stopped
    networks:
      - spreadpilot-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Infrastructure services
  # Removed Firestore service definition

  ib-gateway:
    image: ghcr.io/gnzsnz/ib-gateway:latest
    container_name: spreadpilot-ib-gateway
    environment:
      - TWS_USERID=${IB_USERNAME}
      - TWS_PASSWORD=${IB_PASSWORD}
      - TRADING_MODE=paper
    ports:
      - "4002:4002"
    networks:
      - spreadpilot-network
    restart: unless-stopped

  mongodb:
    image: mongo:7
    container_name: spreadpilot-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    volumes:
      - mongo_data:/data/db
    ports:
      - "27018:27017"
    restart: unless-stopped
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 40s
    networks:
      - spreadpilot-network

  redis:
    image: redis:7-alpine
    container_name: spreadpilot-redis
    ports:
      - "6380:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - spreadpilot-network

  vault:
    image: vault:1.13.3
    container_name: spreadpilot-vault
    cap_add:
      - IPC_LOCK
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=${VAULT_TOKEN:-myroot}
      - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
    ports:
      - "8201:8200"
    networks:
      - spreadpilot-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Observability services

  # Development email preview (optional - only for dev/testing)
  mailhog:
    image: mailhog/mailhog:latest
    container_name: spreadpilot-mailhog
    ports:
      - "1025:1025"  # SMTP server
      - "8025:8025"  # Web UI
    networks:
      - spreadpilot-network
    restart: unless-stopped
    profiles:
      - dev  # Only start with --profile dev

  # Paper trading gateway (optional - only for paper trading mode)
  paper-gateway:
    build:
      context: ./paper-gateway
      dockerfile: Dockerfile
    container_name: spreadpilot-paper-gateway
    labels:
      - "spreadpilot"
    environment:
      - MONGO_URI=mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongodb:27017
      - MONGO_DB_NAME=spreadpilot_paper
      - PAPER_INITIAL_BALANCE=${PAPER_INITIAL_BALANCE:-100000}
      - PAPER_COMMISSION_RATE=${PAPER_COMMISSION_RATE:-0.005}
      - PAPER_OPTION_COMMISSION=${PAPER_OPTION_COMMISSION:-0.65}
      - PAPER_SLIPPAGE_BPS=${PAPER_SLIPPAGE_BPS:-5}
      - PAPER_VOLATILITY=${PAPER_VOLATILITY:-0.02}
      - MARKET_DATA_SOURCE=${MARKET_DATA_SOURCE:-mock}
      - LOG_LEVEL=INFO
    ports:
      - "4003:4003"  # Paper gateway API
    networks:
      - spreadpilot-network
    depends_on:
      - mongodb
    restart: unless-stopped
    profiles:
      - paper  # Only start with --profile paper
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4003/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

volumes:
  mongo_data:
  redis_data:
  vault_data:

networks:
  spreadpilot-network:
    driver: bridge