version: '3.8'

services:
  # Core services
  trading-bot:
    build:
      context: .
      dockerfile: trading-bot/Dockerfile
    container_name: spreadpilot-trading-bot
    environment:
      - GOOGLE_CLOUD_PROJECT=spreadpilot-dev
      - FIRESTORE_EMULATOR_HOST=firestore:8080
      - IB_GATEWAY_HOST=ib-gateway
      - IB_GATEWAY_PORT=4002
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - GOOGLE_SHEET_URL=${GOOGLE_SHEET_URL}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials/service-account.json
    volumes:
      - ./credentials:/app/credentials
    depends_on:
      # - firestore # Removed Firestore dependency
      - mongodb # Added MongoDB dependency
      - ib-gateway
    ports:
      - "8081:8080"
    restart: unless-stopped

  watchdog:
    build:
      context: ./watchdog
      dockerfile: Dockerfile
    container_name: spreadpilot-watchdog
    environment:
      - CHECK_INTERVAL_SECONDS=15
      - HEALTH_CHECK_TIMEOUT=5
      - MAX_CONSECUTIVE_FAILURES=3
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock  # Docker socket for container management
      - ./spreadpilot-core:/app/spreadpilot-core    # Core library for alerts
    depends_on:
      - trading-bot
      - admin-api
      - report-worker
      - frontend
    networks:
      - spreadpilot-network
    restart: unless-stopped

  admin-api:
    build:
      context: .
      dockerfile: admin-api/Dockerfile
    container_name: spreadpilot-admin-api
    environment:
      - GOOGLE_CLOUD_PROJECT=spreadpilot-dev
      # - FIRESTORE_EMULATOR_HOST=firestore:8080 # Removed Firestore
      - MONGO_URI=mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongodb:27017 # Updated MongoDB URI with auth
      - MONGO_DB_NAME=spreadpilot_admin_test # Use a dedicated test DB name
      - TRADING_BOT_HOST=trading-bot
      - TRADING_BOT_PORT=8080
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD_HASH=${ADMIN_PASSWORD_HASH}
      - JWT_SECRET=${JWT_SECRET:-testsecret} # Added default for testing
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials/service-account.json
    volumes:
      - ./credentials:/app/credentials
    depends_on:
      # - firestore # Removed Firestore dependency
      - mongodb # Added MongoDB dependency
      - trading-bot
    ports:
      - "8083:8080"
    restart: unless-stopped

  report-worker:
    build:
      context: .
      dockerfile: report-worker/Dockerfile
    container_name: spreadpilot-report-worker
    environment:
      - GOOGLE_CLOUD_PROJECT=spreadpilot-dev
      - FIRESTORE_EMULATOR_HOST=firestore:8080
      - MONGO_URI=mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongodb:27017 # Updated MongoDB URI with auth
      - MONGO_DB_NAME=spreadpilot_admin_test # Use a dedicated test DB name
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials/service-account.json
    volumes:
      - ./credentials:/app/credentials
      - ./reports:/app/reports
    depends_on:
      # - firestore # Removed Firestore dependency
      - mongodb # Added MongoDB dependency
    restart: unless-stopped

  alert-router:
    build:
      context: .
      dockerfile: alert-router/Dockerfile
    container_name: spreadpilot-alert-router
    environment:
      - GOOGLE_CLOUD_PROJECT=spreadpilot-dev
      - FIRESTORE_EMULATOR_HOST=firestore:8080
      - MONGO_URI=mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongodb:27017 # Updated MongoDB URI with auth
      - MONGO_DB_NAME=spreadpilot_admin_test # Use a dedicated test DB name
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - DASHBOARD_URL=${DASHBOARD_URL:-http://localhost:8080}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials/service-account.json
    volumes:
      - ./credentials:/app/credentials
    depends_on:
      # - firestore # Removed Firestore dependency
      - mongodb # Added MongoDB dependency
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: spreadpilot-frontend
    ports:
      - "8080:80"
    depends_on:
      - admin-api
    restart: unless-stopped

  # Infrastructure services
  # Removed Firestore service definition

  ib-gateway:
    image: ghcr.io/gnzsnz/ib-gateway:latest
    container_name: spreadpilot-ib-gateway
    environment:
      - TWS_USERID=${IB_USERNAME}
      - TWS_PASSWORD=${IB_PASSWORD}
      - TRADING_MODE=paper
    ports:
      - "4002:4002"
    restart: unless-stopped

  mongodb:
    image: mongo:7
    container_name: spreadpilot-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    volumes:
      - mongo_data:/data/db
    ports:
      - "27017:27017" # Expose to host for potential direct access during dev
    restart: unless-stopped
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 40s

  # Observability services

volumes:
  prometheus-data:
  grafana-data:
  mongo_data: