name: CI Pipeline

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # Python linting and formatting checks
  python-lint:
    name: Python Linting (Ruff & Black)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', '**/setup.py') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff black

      - name: Run Ruff linter
        run: |
          ruff check . --output-format=github

      - name: Run Black formatter check
        run: |
          black --check --diff .

  # Python unit tests
  python-tests:
    name: Python Unit Tests (Pytest)
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_ROOT_USERNAME: testuser
          MONGO_INITDB_ROOT_PASSWORD: testpass
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand({ping: 1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', '**/setup.py') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install -e ./spreadpilot-core

      - name: Run unit tests with coverage
        env:
          MONGO_URI: mongodb://testuser:testpass@localhost:27017/test?authSource=admin
          REDIS_URL: redis://localhost:6379
          PYTHONPATH: ${{ github.workspace }}:${{ github.workspace }}/trading-bot:${{ github.workspace }}/admin-api:${{ github.workspace }}/alert-router:${{ github.workspace }}/report-worker:${{ github.workspace }}/watchdog
        run: |
          pytest tests/unit/ -v --cov=. --cov-report=xml --cov-report=html --cov-report=term

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

      - name: Upload coverage HTML report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/

  # Frontend tests and build
  frontend-tests:
    name: Frontend Tests & Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run type check
        run: npm run type-check || true

      - name: Run tests
        run: npm test -- --coverage --watchAll=false || true

      - name: Build frontend
        run: npm run build

  # End-to-end tests
  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      - name: Create test environment file
        run: |
          cat > .env.test <<EOF
          ENV=test
          MONGO_INITDB_ROOT_USERNAME=testuser
          MONGO_INITDB_ROOT_PASSWORD=testpass
          JWT_SECRET=test-secret-key
          VAULT_TOKEN=test-vault-token
          TELEGRAM_BOT_TOKEN=test-telegram-token
          TELEGRAM_CHAT_ID=test-chat-id
          EOF

      - name: Build E2E test images
        run: |
          docker-compose -f docker-compose.e2e.yml build --parallel

      - name: Run E2E tests with docker-compose
        run: |
          docker-compose -f docker-compose.e2e.yml up --exit-code-from e2e-tests --abort-on-container-exit
        timeout-minutes: 15

      - name: Collect docker logs on failure
        if: failure()
        run: |
          docker-compose -f docker-compose.e2e.yml logs > docker-logs.txt

      - name: Upload docker logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: docker-logs
          path: docker-logs.txt

      - name: Cleanup E2E containers
        if: always()
        run: |
          docker-compose -f docker-compose.e2e.yml down -v --remove-orphans

  # Security scanning with Trivy
  security-scan:
    name: Security Scan (Trivy)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner in repo mode
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          ignore-unfixed: true

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Trivy in JSON format for artifact
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'
          output: 'trivy-report.json'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'

      - name: Upload Trivy scan results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: trivy-security-scan
          path: |
            trivy-results.sarif
            trivy-report.json

  # Docker image scanning
  docker-scan:
    name: Docker Image Security Scan
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [trading-bot, admin-api, report-worker, alert-router, watchdog]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ matrix.service }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-${{ matrix.service }}-
            ${{ runner.os }}-buildx-

      - name: Build Docker image
        run: |
          docker buildx build \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \
            --load \
            -t spreadpilot/${{ matrix.service }}:scan \
            -f ${{ matrix.service }}/Dockerfile .
          
      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Run Trivy on Docker image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'spreadpilot/${{ matrix.service }}:scan'
          format: 'sarif'
          output: 'trivy-${{ matrix.service }}.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Docker scan results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-docker-${{ matrix.service }}
          path: trivy-${{ matrix.service }}.sarif

  # Integration test for all components
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [python-lint, python-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', '**/setup.py') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install -e ./spreadpilot-core

      - name: Run integration tests
        run: |
          pytest tests/integration/ -v --maxfail=5

  # All tests must pass
  all-tests-pass:
    name: All Tests Pass
    runs-on: ubuntu-latest
    needs: [python-lint, python-tests, frontend-tests, e2e-tests, security-scan, integration-tests]
    steps:
      - name: All tests passed
        run: echo "All tests and security scans passed successfully!"